#!/bin/python3

import socket
import sys
import paramiko
import re
import getpass


class bcolors:
    HEADER = '\033[95m'
    OKBLUE = '\033[94m'
    OKGREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'
    UNDERLINE = '\033[4m'


def ssh_test(vcenter, port):
    print("Testing the vCenter IP: " + vcenter)
    try:
        s.connect((vcenter, port))
        if s.recv(1024) != "":
            print(bcolors.OKGREEN + "SSH is open on the host" + bcolors.ENDC)

    except:
        print(bcolors.FAIL + "Port 22 is closed on the target. Please enable." + bcolors.ENDC)
        exit()

def vuln_check(vcenter):
    ssh = paramiko.SSHClient()
    ssh.load_system_host_keys()
    username = 'root'
    print("Assuming user name is root")
    print("Please enter your VCSA root password")
    password = getpass.getpass()
    print("Restarting service vmdir")
    ssh.connect(vcenter, username=username, password=password)
    ssh_stdin, ssh_stdout, ssh_stderr = ssh.exec_command('com.vmware.appliance.version1.services.restart --name vmdird')
    ssh.connect(vcenter, username=username, password=password)
    ssh_stdin, ssh_stdout, ssh_stderr = ssh.exec_command('shell cat /var/log/vmware/vmdird/vmdird-syslog.log | grep "ACL MODE: Legacy"')
    output = ssh_stdout.read()
    if output.rstrip().decode("utf-8") == "Shell access is granted to root":
        print("The telling log was not seen. Proceeding with version check")
    else:
        print(bcolors.FAIL + output.rstrip().decode("utf-8") + bcolors.ENDC)
        print(bcolors.FAIL + "You are vulnerable! Please patch ASAP" + bcolors.ENDC)
    ssh.connect(vcenter, username=username, password=password)
    ssh_stdin, ssh_stdout, ssh_stderr = ssh.exec_command('com.vmware.appliance.version1.system.version.get')
    output = ssh_stdout.read()
    output_clean = output.rstrip().decode("utf-8")
    vcenter_version = re.findall('Build:\s([0-9]+)', output_clean)
    if int(vcenter_version[0]) < 15976714 and int(vcenter_version[0]) < 14836121:
        print(bcolors.FAIL + "You are running vCenter 6.7 without patch U3f which means you may still be vulnerable" + bcolors.ENDC)
    else:
        print(bcolors.OKGREEN + "You are not running a vulnerable version of vCenter" + bcolors.ENDC)
    ssh.close()
if __name__ == '__main__':
    if len(sys.argv) == 2:
        target = socket.gethostbyname(sys.argv[1])
    else:
        print("Invalid arguments")
        print("Syntax: python3 CVE-2020-3952.py <hostname>")
    s = socket.socket()
    port = 22
    ssh_test(target, port)
    vuln_check(target)